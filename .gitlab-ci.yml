variables:
  GIT_SUBMODULE_STRATEGY: recursive
  
stages:
  - download
  - build
  - ZipUp

#
# Download CBACnet Stack libaries 
# -----------------------------------------------------------------------------
# How to download artifacts from jobs in Gitlab CI https://docs.gitlab.com/ee/api/jobs.html#download-the-artifacts-archive 
# Note: the SETTING_PRIVATE_TOKEN parameter is a enviment variable, generated by Steven's user. 
# 
Download BACnet Stack Libaries:
  stage: download
  tags:
    - docker
  image: alpine:latest
  only:
    - pushes
  variables:
    GIT_SUBMODULE_STRATEGY: none
  script:
    # Install Zip and curl 
    - "apk --no-cache add unzip curl"
    - 'curl --location --output CASBACnetStackLibs.zip --header "PRIVATE-TOKEN: $SETTING_PRIVATE_TOKEN" "https://gitlab.com/api/v4/projects/7281208/jobs/artifacts/master/download?job=Windows%20Release%20Win32%20CASBACnetStack%20LIB&job_token=$CI_JOB_TOKEN"'
    - unzip CASBACnetStackLibs.zip && rm -f CASBACnetStackLibs.zip
    - 'curl --location --output CASBACnetStackLibs.zip --header "PRIVATE-TOKEN: $SETTING_PRIVATE_TOKEN" "https://gitlab.com/api/v4/projects/7281208/jobs/artifacts/master/download?job=Linux-Ubuntu%20Release%20x64%20CASBACnetStack&job_token=$CI_JOB_TOKEN"'
    - unzip CASBACnetStackLibs.zip && rm -f CASBACnetStackLibs.zip
    - ls -ls bin/ 
  artifacts:
    expire_in: 1 days
    paths:
      - bin/*.lib
      - bin/*.a

# Build the windows version 
Windows Win32 Release:
  stage: build
  tags:
    - windows
    - msvs
  before_script:
    # Add MSBuild.exe to path
    - set PATH=%PATH%;C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\MSBuild\Current\Bin
    # Update the CIBuildVersion.cs
    - "echo const int CI_PIPELINE_IID = %CI_PIPELINE_IID% >BACnetServerExample/CIBuildSettings.h"
    - type BACnetServerExample\CIBuildVersion.h
  script:
    # Create the bin directory if it does not exist
    - cd BACnetServerExample
    # Build and package the project in an apk for android
    - msbuild /p:Configuration=Release /p:Platform="x86"
    - cd ..\bin
    - dir
  artifacts:
    expire_in: 1 days
    paths:
      - bin/BACnetServerExample_Win32_Release.exe
  dependencies:
    - Download BACnet Stack Libaries

# Build the linux 64bit version 
Linux 64Bit Release:
  stage: build
  tags:
    - docker     
  image: ssmethurst/ubuntudev-18_04:latest
  before_script:
    # Update the CIBuildVersion.cs
    - echo -e "const int CI_PIPELINE_IID = $CI_PIPELINE_IID\n" >BACnetServerExample/CIBuildSettings.h 
    # debug info 
    - "gcc -v"   
  script:
    - "make"
    - "make install"
  artifacts:
    expire_in: 1 days
    paths:
      - bin/BACnetServerExampleCPP_linux_x64_Release
  dependencies:
    - Download BACnet Stack Libaries    

Linux-Rpi Arm7:
  <<: *linux_all_features
  stage: build  
  when: manual  
  tags: 
    - arm7
  script:
    - "apk --no-cache add unzip curl"
    - 'curl --location --output CASBACnetStackLibs.zip --header "PRIVATE-TOKEN: $SETTING_PRIVATE_TOKEN" "https://gitlab.com/api/v4/projects/7281208/jobs/artifacts/master/download?job=Linux-Rpi%20Arm7%20CASBACnetStack&job_token=$CI_JOB_TOKEN"'
    - unzip CASBACnetStackLibs.zip && rm -f CASBACnetStackLibs.zip    
    - uname -a  
    - gcc --version 
    - "make -f=makefileArm7"
    - "make install -f=makefileArm7"    
  artifacts:
    expire_in: 1 days
    paths:
      - bin/BACnetServerExampleCPP_linux_Arm7_Release

# CreateZip
Create Zip:
  stage: ZipUp
  tags:
    - docker
  image: alpine:latest
  variables:
    GIT_SUBMODULE_STRATEGY: none  
  only:
    - master
  dependencies:
    - Linux 64Bit Release
    - Windows Win32 Release
  script:
    # Install Zip 
    - "apk --no-cache add zip"
    # Remove the old zip if it exists for some reason     
    - "rm -f BACnetServerExampleCPP_build$CIPIPELINE_IID.zip"
    # Add all the compiled libaries from other jobs. 
    - "zip BACnetServerExampleCPP_build$CI_PIPELINE_IID.zip -r9 bin/BACnetServerExampleCPP_linux_x64_Release bin/BACnetServerExample_Win32_Release.exe"
  artifacts:
    paths:
      - BACnetServerExampleCPP_build$CI_PIPELINE_IID.zip
